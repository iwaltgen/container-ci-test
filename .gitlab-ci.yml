image: docker:stable

services:
  - docker:dind

variables:
  DOCKER_DRIVER: overlay2
  IMAGE_NAME: $REGISTRY_URL/$CI_PROJECT_PATH

build server:
  stage: build
  environment:
    name: development
  # only:
  #   - master
  script:
    - docker login -u $REGISTRY_USERNAME -p $REGISTRY_PASSWORD $REGISTRY_URL
    - docker pull $IMAGE_NAME || true
    - docker build --cache-from $IMAGE_NAME:latest -t $IMAGE_NAME .
    - docker push $IMAGE_NAME
    - docker image rm $IMAGE_NAME
